name: Contract Validation

# Runs weekly to validate API contracts against real third-party APIs.
# This detects API drift before it breaks production.

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      providers:
        description: 'Providers to validate (comma-separated, or "all")'
        required: false
        default: 'all'

permissions:
  contents: read
  issues: write

env:
  CONTRACT_VALIDATION: "1"

jobs:
  # AWS API Contract Validation
  aws-contracts:
    name: AWS API Contracts
    runs-on: ubuntu-latest
    # Only run if AWS sandbox credentials are configured
    if: ${{ github.event.inputs.providers == 'all' || contains(github.event.inputs.providers, 'aws') || github.event_name == 'schedule' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Check for contract tests and credentials
        id: check-contracts
        env:
          AWS_KEY_ID: ${{ secrets.AWS_SANDBOX_ACCESS_KEY_ID }}
        run: |
          # Check if AWS credentials are configured
          if [ -z "$AWS_KEY_ID" ]; then
            echo "has_credentials=false" >> $GITHUB_OUTPUT
            echo "::notice::AWS sandbox credentials not configured - skipping AWS contract validation"
            echo "AWS sandbox credentials not configured - skipping" | tee aws-iam-results.txt
          else
            echo "has_credentials=true" >> $GITHUB_OUTPUT
          fi

          # Check if contract tests exist
          if [ -d "contracts/aws" ] && find contracts/aws -name "*_test.go" -type f 2>/dev/null | grep -q .; then
            echo "has_contracts=true" >> $GITHUB_OUTPUT
          else
            echo "has_contracts=false" >> $GITHUB_OUTPUT
            echo "No AWS contract tests found yet" | tee aws-iam-results.txt
          fi

      - name: Configure AWS credentials
        if: steps.check-contracts.outputs.has_credentials == 'true' && steps.check-contracts.outputs.has_contracts == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_SANDBOX_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SANDBOX_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_SANDBOX_REGION || 'us-east-1' }}

      - name: Validate AWS IAM contracts
        if: steps.check-contracts.outputs.has_credentials == 'true' && steps.check-contracts.outputs.has_contracts == 'true'
        run: |
          go test -tags=contract -v ./contracts/aws/... -run TestIAMContract 2>&1 | tee aws-iam-results.txt
        continue-on-error: true

      - name: Upload AWS results
        uses: actions/upload-artifact@v4
        with:
          name: aws-contract-results
          path: aws-*-results.txt
        if: always()

  # GitHub API Contract Validation
  github-contracts:
    name: GitHub API Contracts
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.providers == 'all' || contains(github.event.inputs.providers, 'github') || github.event_name == 'schedule' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Validate GitHub contracts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_SANDBOX_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_ORG: ${{ secrets.GITHUB_SANDBOX_ORG }}
        run: |
          if [ -d "contracts/github" ] && [ -n "$(ls -A contracts/github/*_validation_test.go 2>/dev/null)" ]; then
            go test -tags=contract -v ./contracts/github/... 2>&1 | tee github-results.txt
          else
            echo "No GitHub contract validation tests found yet" | tee github-results.txt
          fi
        continue-on-error: true

      - name: Upload GitHub results
        uses: actions/upload-artifact@v4
        with:
          name: github-contract-results
          path: github-results.txt
        if: always()

  # GCP API Contract Validation (placeholder)
  gcp-contracts:
    name: GCP API Contracts
    runs-on: ubuntu-latest
    if: ${{ (github.event.inputs.providers == 'all' || contains(github.event.inputs.providers, 'gcp')) && github.event_name != 'schedule' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Validate GCP contracts
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GCP_SANDBOX_SERVICE_ACCOUNT }}
        run: |
          if [ -d "contracts/gcp" ] && [ -n "$(ls -A contracts/gcp/*_validation_test.go 2>/dev/null)" ]; then
            echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/gcp-creds.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-creds.json
            go test -tags=contract -v ./contracts/gcp/... 2>&1 | tee gcp-results.txt
            rm /tmp/gcp-creds.json
          else
            echo "No GCP contract validation tests found yet" | tee gcp-results.txt
          fi
        continue-on-error: true

  # Summary and alerting
  contract-summary:
    name: Contract Validation Summary
    runs-on: ubuntu-latest
    needs: [aws-contracts, github-contracts]
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results
        continue-on-error: true

      - name: Generate summary
        id: summary
        run: |
          echo "## Contract Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AWS | ${{ needs.aws-contracts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub | ${{ needs.github-contracts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for failures
          FAILED="false"
          if [[ "${{ needs.aws-contracts.result }}" == "failure" ]]; then
            FAILED="true"
            echo "### AWS Contract Failures" >> $GITHUB_STEP_SUMMARY
            if [ -f "results/aws-contract-results/aws-iam-results.txt" ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 "FAIL\|Error\|does not match" results/aws-contract-results/*.txt >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ needs.github-contracts.result }}" == "failure" ]]; then
            FAILED="true"
            echo "### GitHub Contract Failures" >> $GITHUB_STEP_SUMMARY
            if [ -f "results/github-contract-results/github-results.txt" ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 "FAIL\|Error\|does not match" results/github-contract-results/*.txt >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [[ "$FAILED" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required**: API contracts may have drifted. Review failures and update contracts if needed." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All contract validations passed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: steps.summary.outputs.failed == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `API Contract Drift Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## API Contract Validation Failed

            The weekly contract validation job detected potential API drift.

            **AWS Contracts**: ${{ needs.aws-contracts.result }}
            **GitHub Contracts**: ${{ needs.github-contracts.result }}

            ### Next Steps

            1. Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Check which API responses no longer match expected schemas
            3. Determine if this is:
               - A breaking API change (update code to handle)
               - A non-breaking addition (update contract schema)
               - A test environment issue (fix sandbox setup)
            4. Update contracts and/or code as needed
            5. Run validation manually to confirm fix

            /cc @tracevault/maintainers
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'contract-drift',
              per_page: 10
            });

            const existingIssue = issues.data.find(i => i.title.includes('API Contract Drift'));
            if (existingIssue) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Contract validation failed again on ${new Date().toISOString().split('T')[0]}.\n\nSee [run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['contract-drift', 'bug', 'automated']
              });
            }
